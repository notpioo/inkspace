<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>{% block title %}InkSpace{% endblock %}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
</head>
<body{% if 'user_id' in session %} class="has-chrome"{% endif %}>
    {% if 'user_id' in session %}
    <!-- Desktop Navbar (hidden on mobile) -->
    <nav class="navbar navbar-expand-lg navbar-dark sticky-top d-none d-lg-block desktop-header">
        <div class="container">
            <a href="{{ url_for('index') }}" class="navbar-brand">
                <i class="fas fa-sticky-note"></i>
                InkSpace
            </a>

            <div class="navbar-nav ms-auto d-flex align-items-center">
                <a href="{{ url_for('index') }}" class="nav-link {% if request.endpoint == 'index' %}active{% endif %}">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="{{ url_for('my_notes') }}" class="nav-link {% if request.endpoint == 'my_notes' %}active{% endif %}">
                    <i class="fas fa-sticky-note"></i> Catatan
                </a>

                <!-- Profile Dropdown -->
                <div class="nav-item dropdown">
                    {% set current_user = {} %}
                    {% for user_id, user_data in (load_users() or {}).items() %}
                        {% if user_id == session['user_id'] %}
                            {% set _ = current_user.update(user_data) %}
                        {% endif %}
                    {% endfor %}

                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        {% if current_user.get('profile_photo') %}
                            <img src="{{ url_for('get_profile_photo', user_id=session['user_id']) }}" 
                                 alt="Profile" class="profile-image" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 0.5rem;">
                        {% endif %}
                        {{ current_user.get('name', 'User') }}
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{{ url_for('profile') }}">
                            <i class="fas fa-user me-2"></i> Profil
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('settings') }}">
                            <i class="fas fa-cog me-2"></i> Pengaturan
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="{{ url_for('logout') }}">
                            <i class="fas fa-sign-out-alt me-2"></i> Keluar
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Mobile-First Header -->
    <header class="mobile-header sticky-top d-block d-lg-none">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center py-2">
                <!-- Logo and App Name -->
                <a href="{{ url_for('index') }}" class="app-brand d-flex align-items-center text-decoration-none">
                    <i class="fas fa-sticky-note brand-icon"></i>
                    <span class="brand-text">InkSpace</span>
                </a>

                <!-- Profile Button -->
                <div class="profile-section">
                    {% set current_user = {} %}
                    {% for user_id, user_data in (load_users() or {}).items() %}
                        {% if user_id == session['user_id'] %}
                            {% set _ = current_user.update(user_data) %}
                        {% endif %}
                    {% endfor %}

                    <div class="dropdown">
                        <button class="profile-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Menu profil">
                            {% if current_user.get('profile_photo') %}
                                <img src="{{ url_for('get_profile_photo', user_id=session['user_id']) }}" 
                                     alt="Foto profil {{ current_user.get('name', 'User') }}" 
                                     class="profile-avatar">
                            {% else %}
                                <div class="profile-avatar profile-avatar-initial">
                                    {{ current_user.get('name', 'U')[0].upper() }}
                                </div>
                            {% endif %}
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="{{ url_for('profile') }}">
                                <i class="fas fa-user me-2"></i> Profil
                            </a></li>
                            <li><a class="dropdown-item" href="{{ url_for('settings') }}">
                                <i class="fas fa-cog me-2"></i> Pengaturan
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="{{ url_for('logout') }}">
                                <i class="fas fa-sign-out-alt me-2"></i> Keluar
                            </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>
    {% endif %}

    <!-- Desktop Header -->
    {% if 'user_id' in session %}
    <div class="d-none d-lg-block">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center py-3">
                <div>
                    {% block page_header %}{% endblock %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Main Content Area -->
    <main class="main-content">
        <div class="container-fluid px-3">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show mobile-alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            {% block content %}{% endblock %}
        </div>
    </main>

    {% if 'user_id' in session %}
    <!-- Mobile Bottom Navigation -->
    <nav class="bottom-nav fixed-bottom">
        <div class="container-fluid">
            <div class="row">
                <div class="col-6">
                    <a href="{{ url_for('index') }}" class="nav-item {% if request.endpoint == 'index' %}active{% endif %}">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                </div>
                <div class="col-6">
                    <a href="{{ url_for('my_notes') }}" class="nav-item {% if request.endpoint == 'my_notes' %}active{% endif %}">
                        <i class="fas fa-sticky-note"></i>
                        <span>Catatan</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dynamic Floating Action Button -->
    {% if request.endpoint == 'index' %}
    <a href="{{ url_for('publish_notes') }}" class="fab-btn" aria-label="Publikasikan catatan">
        <i class="fas fa-share"></i>
    </a>
    {% else %}
    <button class="fab-btn" data-bs-toggle="modal" data-bs-target="#noteModal" aria-label="Tulis catatan baru">
        <i class="fas fa-plus"></i>
    </button>
    {% endif %}
    {% endif %}

    <!-- Mobile-Optimized Note Creation Modal -->
    {% if 'user_id' in session %}
    <div class="modal fade" id="noteModal" tabindex="-1" aria-labelledby="noteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen-sm-down modal-dialog-centered">
            <div class="modal-content mobile-modal">
                <div class="modal-header">
                    <h5 class="modal-title" id="noteModalLabel">
                        <i class="fas fa-edit"></i> Catatan Baru
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{{ url_for('note') }}" id="noteModalForm">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <div class="mb-3">
                            <label for="modalTitle" class="form-label">Judul</label>
                            <input type="text" class="form-control mobile-input" id="modalTitle" name="title" required 
                                   placeholder="Judul catatan...">
                        </div>

                        <div class="mb-3">
                            <label for="modalContent" class="form-label">Isi Catatan</label>
                            <textarea class="form-control mobile-input mobile-textarea" id="modalContent" name="content" rows="5" required 
                                      placeholder="Tulis catatan di sini..."></textarea>
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-check-modern mb-3">
                                <input class="form-check-input" type="checkbox" id="modalIsPublic" name="is_public">
                                <label class="form-check-label" for="modalIsPublic">
                                    <i class="fas fa-globe me-1"></i> Bagikan ke publik
                                </label>
                            </div>

                            <div class="form-check form-check-modern">
                                <input class="form-check-input" type="checkbox" id="modalIsLocked" name="is_locked">
                                <label class="form-check-label" for="modalIsLocked">
                                    <i class="fas fa-lock me-1"></i> Kunci dengan PIN
                                </label>
                            </div>

                            <!-- PIN Options -->
                            <div id="modalPinOptions" class="pin-options mt-3" style="display: none;">
                                <div class="pin-card">
                                    <h6 class="pin-title">
                                        <i class="fas fa-key me-1"></i> Pilih jenis PIN
                                    </h6>

                                    <div class="form-check form-check-modern mb-2">
                                        <input class="form-check-input" type="radio" name="pin_option" id="modalUseAppPin" value="app_pin" checked>
                                        <label class="form-check-label" for="modalUseAppPin">
                                            PIN App Lock
                                        </label>
                                    </div>

                                    <div class="form-check form-check-modern mb-3">
                                        <input class="form-check-input" type="radio" name="pin_option" id="modalUseCustomPin" value="custom_pin">
                                        <label class="form-check-label" for="modalUseCustomPin">
                                            PIN khusus
                                        </label>
                                    </div>

                                    <!-- Custom PIN Input -->
                                    <div id="modalCustomPinInput" class="custom-pin-input" style="display: none;">
                                        <label for="modalNotePin" class="form-label">PIN (4 digit)</label>
                                        <input type="password" class="form-control mobile-input pin-input" id="modalNotePin" name="note_pin" 
                                               maxlength="4" pattern="[0-9]{4}" placeholder="0000">
                                        <small class="form-text text-muted">PIN akan diminta saat membuka catatan</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer mobile-modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        Batal
                    </button>
                    <button type="submit" form="noteModalForm" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> Simpan
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>

    <!-- Modal JavaScript -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Modal lock functionality
        const modalIsLocked = document.getElementById('modalIsLocked');
        const modalPinOptions = document.getElementById('modalPinOptions');
        const modalUseCustomPin = document.getElementById('modalUseCustomPin');
        const modalCustomPinInput = document.getElementById('modalCustomPinInput');

        if (modalIsLocked) {
            modalIsLocked.addEventListener('change', function() {
                if (this.checked) {
                    modalPinOptions.style.display = 'block';
                } else {
                    modalPinOptions.style.display = 'none';
                    modalCustomPinInput.style.display = 'none';
                }
            });
        }

        if (modalUseCustomPin) {
            modalUseCustomPin.addEventListener('change', function() {
                if (this.checked) {
                    modalCustomPinInput.style.display = 'block';
                } else {
                    modalCustomPinInput.style.display = 'none';
                }
            });
        }

        // Reset modal form when closed
        const noteModal = document.getElementById('noteModal');
        if (noteModal) {
            noteModal.addEventListener('hidden.bs.modal', function () {
                const form = document.getElementById('noteModalForm');
                form.reset();
                modalPinOptions.style.display = 'none';
                modalCustomPinInput.style.display = 'none';
            });
        }
    });
    </script>

    {% block scripts %}{% endblock %}
</body>
</html>